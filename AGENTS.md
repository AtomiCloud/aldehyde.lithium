# Repository Guidelines

## Project Structure & Module Organization

- `chart/` — Helm chart for wrapping Logto. Key files: `Chart.yaml`, `values.yaml`, `templates/` (K8s manifests), `Chart.lock`, and `charts/` (vendored deps).
- `tasks/` & `Taskfile.yaml` — Task runners. Helm ops live under the `base:` namespace (e.g., `base:install`).
- `scripts/local/` — Local k3d cluster scripts. `config/dev.yaml` selects the landscape.
- `nix/` & `flake.nix` — Dev shells, formatting, and pre-commit hooks.
- `README.MD` — High-level overview. Avoid editing `chart/README.md`; it’s generated.

## Build & Development Commands

- Bootstrap: `direnv allow` then `nix develop` (loads tools and pre-commit hooks).
- Update deps: `task update` (runs `helm dependency update` in `chart/`).
- Render chart: `task base:template` or `task base:debug` (adds `--debug`).
- Install/upgrade locally: `task base:install` (uses `chart/values.yaml` and optional landscape overrides).
- Remove release: `task base:remove`.
- Local cluster: `task start:cluster` / `task stop:cluster` (k3d, reads `config/dev.yaml`).

## Coding Style & Naming Conventions

- YAML: 2-space indent; quote values with special chars. Keep keys stable; prefer anchors (see `values.yaml`).
- Helm: use helpers from `templates/_helpers.tpl` (e.g., `"aldehyde-lithium.fullname"`, `labels`, `selectorLabels`); prefer `nindent` and `toYaml` for blocks.
- Naming: K8s names are max 63 chars; helpers already truncate—do not hardcode names.
- Values: configure `serviceTree`, `atomiLabels`, `image`, `ingress`, resources, autoscaling in `values.yaml`; avoid environment-specific logic in templates.

## Commit & Pull Request Guidelines

- Conventional Commits enforced by `.gitlint`. Allowed types: `amend, build, chore, ci, config, dep, docs, feat, fix, perf, refactor, release, style, test`.
- Write clear subjects (≤72 chars) and explain the why in body.
- PRs: state intent, link issues, note chart version bumps in `chart/Chart.yaml`, include `task base:template` snippets for impactful manifest changes, and never commit secrets. `chart/README.md` is generated by CI.

## Security & Configuration Tips

- Secrets: never commit. Pre-commit runs Infisical scans. Use external-secrets in clusters.
- Local: k3d landscape from `config/dev.yaml`; set ingress host and image in `values.yaml` for dev.
- Releases: OCI publish via CI (`scripts/ci/helm.sh`); requires `DOMAIN`, `DOCKER_USER`, `DOCKER_PASSWORD` environment variables.
