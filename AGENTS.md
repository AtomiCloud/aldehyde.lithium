# Repository Guidelines

## Project Structure & Module Organization

- `chart/` — Helm chart for Logto. Key files: `Chart.yaml`, `values.yaml`, `templates/`, `Chart.lock`, `charts/`.
- `tasks/` & `Taskfile.yaml` — Task runners. Helm ops live under `base:` (e.g., `base:install`).
- `scripts/local/` — Local k3d helpers. `config/dev.yaml` selects the landscape.
- `nix/` & `flake.nix` — Dev shells, formatting, pre-commit hooks.
- `README.MD` — Overview. Do not edit `chart/README.md`; it is generated.

## Build, Test, and Development Commands

- Bootstrap: `direnv allow` then `nix develop` (loads tools and hooks).
- Task alias: `pls` is aliased to `task` and is used to run most tasks.
- Update deps: `pls update` (runs `helm dependency update` in `chart/`).
- Render chart: `pls base:template` or `pls base:debug` (adds `--debug`).
- Install/upgrade: `pls base:install` (uses `chart/values.yaml` and optional overrides).
- Local cluster: `pls start:cluster` / `pls stop:cluster` (k3d via `config/dev.yaml`).
- Connector pins: `pls connectors:list` prints official `@logto/connector-*@<version>` lines.

## Coding Style & Naming Conventions

- YAML: 2-space indent; quote special chars; prefer anchors (see `values.yaml`).
- Helm: use helpers from `templates/_helpers.tpl` (`"aldehyde-lithium.fullname"`, `labels`, `selectorLabels`); use `nindent`/`toYaml` for blocks.
- Naming: K8s names max 63 chars; rely on helpers, don’t hardcode.
- Values: configure image, ingress, resources, autoscaling in `values.yaml`; keep templates env‑agnostic.

## Testing Guidelines

- Lint/render: `helm lint chart` and `pls base:template` (or `base:debug`) to validate manifests.
- Local smoke test: start k3d (`pls start:cluster`) then `pls base:install`; verify with `kubectl get pods`.

## Commit & Pull Request Guidelines

- Conventional Commits via `.gitlint`. Allowed: `amend, build, chore, ci, config, dep, docs, feat, fix, perf, refactor, release, style, test`.
- Keep subjects ≤72 chars; explain the why in the body.
- PRs: state intent, link issues, call out chart version bumps in `chart/Chart.yaml`, include `pls base:template` snippets for impactful changes, and never commit secrets. `chart/README.md` is generated by CI.

## Security & Configuration Tips

- Never commit secrets; use external-secrets in clusters (pre-commit scans enabled).
- For local dev, set ingress hosts and image in `values.yaml`.
- OCI releases via CI (`scripts/ci/helm.sh`) require `DOMAIN`, `DOCKER_USER`, `DOCKER_PASSWORD`.
